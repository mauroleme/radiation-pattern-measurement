clear;                                                      % Limpa variáveis do workspace
clc;                                                        % Limpa o Command Window

% Configuração da porta serial
arduinoPort = "COM7";                                       % Porta COM usada pelo Arduino
baudRate    = 115200;                                       % Taxa de comunicação serial (bps)

% Inicializa a porta serial se ainda não estiver configurada
if ~exist('port', 'var')
    port            = serialport(arduinoPort, baudRate);    % Configura a porta serial
    port.Timeout    = 30;                                   % Define tempo limite de espera
    configureTerminator(port, "CR/LF");                    % Define terminador de linha
end

disp("Waiting for Arduino...");
while true
    try
        response = readline(port);
        if strcmp(response, "Motor homed.");
            break;
        elseif strncmp(response, "Error", 5);
            error("Error during setup.");
        end
    catch
        pause(0.5);
    end
end


disp("Solicitando medições para 360°...");

% Inicializa a matriz de resultados
numSamplesPerDegree = 10;
values              = zeros(360, 1);                        % Vetor para armazenar as medições totais

for i=1:360
    try
        response        = writeread(porto, "1");
        degreeSamples   = str2double(split(response, ','));
        if any(isnan(degreeSamples))
            error("Invalind response format.");
        end
    catch
        degreeSamples   = -1 * ones(numSamplesPerDegree, 1);
    end
    values(i) = mean(degreeSamples);
    disp("Degree Values:");
    disp(values(i));
end

disp("Collected samples:");
disp(values);                                              % Mostra a o vetor coletado

clear port;                                                % Fecha e limpa a configuração da porta serial
